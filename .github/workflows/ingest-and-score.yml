name: Ingest and Score New Observations

on:
  workflow_dispatch:

jobs:
  ingest:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ecology-bio-blitz-scoring

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: 'ecology-bio-blitz-scoring'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      # =================================================================
      # FORENSIC DIAGNOSTICS
      # These steps will log the exact environment state before the script runs.
      # =================================================================
      - name: Verify Environment and Secrets
        run: |
          echo "--- Environment Variables ---"
          printenv | sort
          echo "---------------------------"
          echo "Checking for Supabase URL presence: ${{ env.SUPABASE_URL_PRESENT }}"
          echo "Checking for Service Key presence: ${{ env.SERVICE_KEY_PRESENT }}"
        env:
          # We check for presence without printing the secret value.
          SUPABASE_URL_PRESENT: ${{ !!secrets.SUPABASE_URL }}
          SERVICE_KEY_PRESENT: ${{ !!secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: Run Data Ingestion
        env:
          # Using the exact variable names from your working file
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          INAT_PROJECT_SLUG: ${{ secrets.INAT_PROJECT_SLUG }}
        run: node ingest.mjs
